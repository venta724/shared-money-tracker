<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Money Tracker</title>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>

    <style>
        /* --- CSS (Keep all existing CSS rules the same as before) --- */
        :root { /* Light Mode Defaults */
            --color-primary: #4CAF50; --color-primary-dark: #45a049;
            --color-secondary: #2196F3; --color-secondary-dark: #1976d2; --color-secondary-light: #e3f2fd; --color-secondary-border: #bbdefb;
            --color-danger: #f44336; --color-danger-dark: #d32f2f; --color-danger-light: #ffebee; --color-danger-border: #ffcdd2;
            --color-warning: #FF9800; --color-warning-dark: #e68a00;
            --color-info: #09a2ff; --color-info-dark: #008ae6;
            --color-grey-light: #f9f9f9; --color-grey-medium: #f5f5f5; --color-grey-dark: #e0e0e0; --color-grey-xdark: #ccc; --color-grey-border: #ddd;
            --color-text-default: #333; --color-text-light: #555; --color-text-lighter: #666; --color-text-xlight: #777;
            --color-white: #fff; --color-black-overlay: rgba(0,0,0,0.5);
            --shadow-light: 0 2px 5px rgba(0,0,0,0.1); --shadow-medium: 0 4px 10px rgba(0,0,0,0.2);
            --select-arrow-color-encoded: '%23333';
            --switch-bg: #ccc; --switch-thumb-bg: white; --switch-bg-checked: var(--color-primary);
            --font-family-default: Arial, sans-serif;
            --font-size-xs: 0.7em; --font-size-sm: 0.85em; --font-size-md: 0.9em; --font-size-lg: 1.1em; --font-size-xl: 1.15em; --font-size-xxl: 1.2em; --font-size-xxxl: 1.5em;
            --border-radius-sm: 3px; --border-radius-md: 5px; --border-radius-lg: 10px; --border-radius-xl: 16px;
            --gap-xs: 4px; --gap-sm: 6px; --gap-md: 8px; --gap-lg: 10px; --gap-xl: 15px; --gap-xxl: 20px;
        }
        body.dark-mode {
            --color-primary: #5cb860; --color-primary-dark: #4caf50;
            --color-secondary: #64b5f6; --color-secondary-dark: #42a5f5; --color-secondary-light: #1e3a50; --color-secondary-border: #2c5a8c;
            --color-danger: #e57373; --color-danger-dark: #f44336; --color-danger-light: #4d1a1a; --color-danger-border: #8b2e2e;
            --color-warning: #ffb74d; --color-warning-dark: #ffa726;
            --color-info: #4fc3f7; --color-info-dark: #29b6f6;
            --color-grey-light: #424242; --color-grey-medium: #303030; --color-grey-dark: #555555; --color-grey-xdark: #777777; --color-grey-border: #555;
            --color-text-default: #eeeeee; --color-text-light: #cccccc; --color-text-lighter: #bbbbbb; --color-text-xlight: #aaaaaa;
            --color-white: #1e1e1e; --color-black-overlay: rgba(0,0,0,0.7);
            --shadow-light: 0 2px 8px rgba(0,0,0,0.4); --shadow-medium: 0 4px 15px rgba(0,0,0,0.5);
            --select-arrow-color-encoded: '%23eeeeee';
            --switch-bg: #555; --switch-thumb-bg: #ccc;
        }
        body { font-family: var(--font-family-default); max-width: 800px; margin: 0 auto; padding: var(--gap-xxl); background: var(--color-grey-medium); font-size: 14px; color: var(--color-text-default); transition: background-color 0.3s, color 0.3s; }
        .app { background: var(--color-white); padding: var(--gap-xxl); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-light); transition: background-color 0.3s, box-shadow 0.3s; }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--gap-xxl); flex-wrap: wrap; gap: var(--gap-lg); }
        .app-header h1 { flex-shrink: 0; margin-right: auto; }
        .search-container { flex-grow: 1; max-width: 350px; min-width: 180px; margin-right: var(--gap-lg); }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; flex-shrink: 0; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-bg); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: var(--switch-thumb-bg); transition: .4s; }
        input:checked + .slider { background-color: var(--switch-bg-checked); }
        input:focus + .slider { box-shadow: 0 0 1px var(--switch-bg-checked); }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider.round { border-radius: 26px; }
        .slider.round:before { border-radius: 50%; }
        h1 { font-size: var(--font-size-xxxl); color: inherit; }
        h2 { font-size: var(--font-size-xxl); margin-top: var(--gap-xxl); margin-bottom: var(--gap-lg); color: inherit; }
        h3 { font-size: 1em; color: inherit; }
        input[type="number"], input[type="text"], input[type="date"], select, textarea, button:not(.action-btn), .filter-select, .time-filter-btn, .date-filter, .clear-btn, .export-btn, .bulk-action-btn { padding: var(--gap-sm) var(--gap-lg); margin: 5px 0; box-sizing: border-box; border: 1px solid var(--color-grey-border); border-radius: var(--border-radius-md); width: 100%; font-size: var(--font-size-md); height: 32px; vertical-align: middle; background-color: var(--color-white); color: var(--color-text-default); transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus { border-color: var(--color-primary); box-shadow: 0 0 0 1px var(--color-primary); outline: none; }
        input[type="checkbox"]:not(#theme-checkbox) { width: auto; height: auto; margin-right: var(--gap-md); vertical-align: middle; accent-color: var(--color-primary); }
        .search-container input { border-radius: var(--border-radius-xl); }
        textarea { min-height: 48px; height: auto; resize: vertical; line-height: 1.4; padding-top: var(--gap-md); padding-bottom: var(--gap-md); }
        button:not(.action-btn) { width: auto; cursor: pointer; transition: background 0.2s, border-color 0.2s, color 0.2s; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22' + var(--select-arrow-color-encoded) + '%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: .65em auto; padding-right: 30px; }
        .tabs { display: flex; margin-bottom: var(--gap-xl); }
        .tab { padding: var(--gap-sm) 12px; cursor: pointer; background: var(--color-grey-dark); color: var(--color-text-default); border-radius: var(--border-radius-md) var(--border-radius-md) 0 0; margin-right: var(--gap-xs); font-size: var(--font-size-sm); border: 1px solid var(--color-grey-border); border-bottom: none; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .tab.tab-expense { background-color: var(--color-danger-light); color: var(--color-danger-dark); border-color: var(--color-danger-border); }
        .tab.tab-income { background-color: var(--color-secondary-light); color: var(--color-secondary-dark); border-color: var(--color-secondary-border); }
        .tab.active { background: var(--color-primary); color: var(--color-white); border-color: var(--color-primary); }
        .tab:not(.active):hover { background-color: var(--color-grey-xdark); }
        .tab.tab-expense:not(.active):hover { background-color: var(--color-danger-border); }
        .tab.tab-income:not(.active):hover { background-color: var(--color-secondary-border); }
        .form-container { display: none; border: 1px solid var(--color-grey-border); padding: var(--gap-xl); border-radius: var(--border-radius-md); margin-bottom: var(--gap-xl); background-color: var(--color-grey-light); transition: background-color 0.3s, border-color 0.3s; }
        .form-container.active { display: block; }
        .form-container input, .form-container select, .form-container textarea { margin-bottom: var(--gap-md); }
        .form-container .user-selector { margin-bottom: var(--gap-md); }
        .form-container button { width: 100%; background: var(--color-info); color: var(--color-white); border: none; }
        .form-container button:hover { background: var(--color-info-dark); }
        .filter-container { display: flex; flex-direction: column; gap: var(--gap-md); margin-bottom: var(--gap-xl); padding: var(--gap-lg); background: var(--color-grey-light); border-radius: var(--border-radius-md); transition: background-color 0.3s; }
        .filter-row { display: flex; flex-wrap: wrap; gap: var(--gap-sm); align-items: center; }
        #type-filter { min-width: 90px; flex-grow: 0; flex-shrink: 1; width: auto; }
        .time-filter-btn { flex-grow: 1; }
        #date-filter { min-width: 110px; flex-grow: 1; width: auto; }
        .clear-btn, .export-btn, .bulk-action-btn { flex-grow: 0; }
        .time-filter-btn { background: var(--color-grey-dark); border: 1px solid var(--color-grey-border); color: var(--color-text-default); }
        .time-filter-btn:hover:not(.active) { background: var(--color-grey-xdark); }
        .time-filter-btn.active { background: var(--color-primary); color: var(--color-white); border-color: var(--color-primary-dark); }
        .clear-btn { background: var(--color-danger); color: var(--color-white); border: none; }
        .clear-btn:hover { background: var(--color-danger-dark); }
        .export-btn { background: var(--color-warning); color: var(--color-white); border: none; }
        .export-btn:hover { background: var(--color-warning-dark); }
        .bulk-action-btn { background: var(--color-danger); color: var(--color-white); border: none; margin-left: auto; }
        .bulk-action-btn:hover { background: var(--color-danger-dark); }
        .summary { display: flex; justify-content: space-around; flex-wrap: wrap; gap: var(--gap-lg); margin: var(--gap-xl) 0; padding: var(--gap-lg); background: var(--color-grey-dark); border-radius: var(--border-radius-md); transition: background-color 0.3s; }
        .summary-item { text-align: center; flex: 1; min-width: 80px; }
        .summary-item h3 { margin: 0 0 3px 0; color: var(--color-text-light); font-size: var(--font-size-sm); font-weight: normal; }
        .summary-item p { margin: 0; font-size: var(--font-size-lg); font-weight: bold; }
        #balance { color: var(--color-primary); } #expenses-total { color: var(--color-danger); } #income-total { color: var(--color-secondary); }
        .transaction-list-header { display: flex; align-items: center; padding: 5px 12px; border-bottom: 2px solid var(--color-grey-border); margin-bottom: 5px; }
        .transaction-list-header h2 { margin: 0; flex-grow: 1; }
        #select-all-container { display: flex; align-items: center; font-size: var(--font-size-sm); color: var(--color-text-light); }
        #select-all-container label { margin-left: var(--gap-xs); cursor: pointer;}
        .transaction-list { list-style: none; padding: 0; height: 350px; overflow-y: auto; border: 1px solid var(--color-grey-border); background-color: var(--color-grey-light); position: relative; border-radius: var(--border-radius-sm); transition: background-color 0.3s, border-color 0.3s; }
        .transaction-list li { padding: var(--gap-lg) 12px; border-bottom: 1px solid var(--color-grey-border); display: flex; align-items: flex-start; position: relative; overflow: hidden; background-color: var(--color-white); transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; will-change: transform, opacity; opacity: 1; transform: none; backface-visibility: hidden; }
        .transaction-list li:last-child { border-bottom: none; }
        .transaction-list-item--removing { opacity: 0 !important; }
        .transaction-list li.selected { background-color: var(--color-secondary-light); }
        body.dark-mode .transaction-list li.selected { background-color: var(--color-secondary-light); }
        .transaction-list li.income { border-left: 3px solid var(--color-secondary-dark); }
        .transaction-list li.expense { border-left: 3px solid var(--color-danger-dark); }
        .transaction-checkbox-container { margin-right: var(--gap-lg); padding-top: 2px; }
        .transaction-info { flex-grow: 1; display: flex; flex-direction: column; gap: var(--gap-xs); }
        .transaction-header { display: flex; align-items: center; gap: var(--gap-sm); }
        .type-badge { padding: 2px var(--gap-sm); border-radius: var(--border-radius-sm); font-size: var(--font-size-xs); font-weight: bold; white-space: nowrap; line-height: 1.4; display: inline-block; }
        .type-badge.income { background-color: var(--color-secondary-light); color: var(--color-secondary-dark); border: 1px solid var(--color-secondary-border); }
        .type-badge.expense { background-color: var(--color-danger-light); color: var(--color-danger-dark); border: 1px solid var(--color-danger-border); }
        .type-badge.unknown { background-color: var(--color-grey-dark); color: var(--color-text-light); border: 1px solid var(--color-grey-border); }
        .transaction-category { font-weight: bold; font-size: var(--font-size-md); color: var(--color-text-default); }
        .transaction-details { color: var(--color-text-lighter); font-size: var(--font-size-sm); }
        .transaction-time { font-style: italic; margin-left: var(--gap-sm); font-size: var(--font-size-md); color: var(--color-text-xlight); }
        .transaction-user { font-size: var(--font-size-xs); color: var(--color-text-xlight); margin-top: var(--gap-xs); font-style: italic; }
        .transaction-note { padding: var(--gap-sm) var(--gap-md); background: var(--color-grey-medium); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm); word-wrap: break-word; width: 100%; color: var(--color-text-light); transition: background-color 0.3s; }
        .transaction-right-col { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; text-align: right; margin-left: var(--gap-lg); }
        .transaction-amount { font-size: var(--font-size-xl); font-weight: bold; white-space: nowrap; margin-bottom: var(--gap-xs); }
        .income .transaction-amount { color: var(--color-secondary); } .expense .transaction-amount { color: var(--color-danger); }
        .transaction-actions { display: flex; gap: var(--gap-xs); }
        .action-btn { background: none; border: none; cursor: pointer; padding: 3px; font-size: var(--font-size-sm); border-radius: var(--border-radius-sm); transition: transform 0.1s, background-color 0.1s; height: auto; width: auto; color: var(--color-text-xlight); line-height: 1; }
        .action-btn:hover { transform: scale(1.1); background-color: var(--color-grey-dark); }
        .edit-btn:hover { color: var(--color-secondary); } .delete-btn:hover { color: var(--color-danger); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-black-overlay); justify-content: center; align-items: center; z-index: 1000; transition: background-color 0.3s; }
        .modal-content { background: var(--color-white); color: var(--color-text-default); padding: var(--gap-xl) var(--gap-xxl); border-radius: var(--border-radius-md); width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-medium); transition: background-color 0.3s, color 0.3s, box-shadow 0.3s; }
        .modal-content h3 { margin-top: 0; margin-bottom: var(--gap-xl); font-size: var(--font-size-lg);}
        .modal-content label { font-size: var(--font-size-sm); margin-bottom: 3px; display: block; color: var(--color-text-light); }
        .modal-content input, .modal-content select, .modal-content textarea { margin-bottom: var(--gap-lg); }
        .modal-content input[type="number"], .modal-content input[type="text"], .modal-content input[type="date"], .modal-content select, .modal-content textarea { background-color: var(--color-grey-light); color: var(--color-text-default); border: 1px solid var(--color-grey-border); }
        .modal-actions { display: flex; justify-content: flex-end; gap: var(--gap-md); margin-top: var(--gap-xl); }
        .modal-actions button { width: auto; padding: var(--gap-sm) var(--gap-xl); }
        .cancel-btn { background: var(--color-grey-xdark); border: none; color: var(--color-text-default); }
        .cancel-btn:hover { background: var(--color-grey-dark); filter: brightness(1.1); }
        .confirm-btn, .modal-content button:not(.cancel-btn) { background: var(--color-primary); color: var(--color-white); border: none; }
        .confirm-btn:hover, .modal-content button:not(.cancel-btn):hover { background: var(--color-primary-dark); }
        #delete-modal .confirm-btn, #bulk-delete-modal .confirm-btn { background: var(--color-danger); }
        #delete-modal .confirm-btn:hover, #bulk-delete-modal .confirm-btn:hover { background: var(--color-danger-dark); }
        .export-options select { width: 100%; }
        #export-date-range-container input[type="date"] { width: calc(50% - var(--gap-xs)); }
        .no-transactions { text-align: center; color: var(--color-text-xlight); padding: 25px var(--gap-xl); font-size: var(--font-size-md); }
        .sub-filter-row { display: none; flex-wrap: wrap; gap: var(--gap-md); margin-bottom: var(--gap-lg); padding: var(--gap-md) var(--gap-lg); background: var(--color-grey-dark); border-radius: var(--border-radius-sm); transition: background-color 0.3s; }
        .sub-filter-group { display: flex; flex-direction: column; min-width: 100px; flex-grow: 1;}
        .sub-filter-group label { font-size: 0.75em; margin-bottom: 3px; color: var(--color-text-lighter); }
        .sub-filter-row .filter-select { width: 100%; }
        #notification-area { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: var(--gap-md); width: 90%; max-width: 500px; pointer-events: none; }
        .notification { background-color: #333; color: var(--color-white); padding: 10px 15px; border-radius: var(--border-radius-md); box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: var(--font-size-md); opacity: 0; transform: translateY(-20px); animation: notification-fade 0.3s ease-out forwards; pointer-events: auto; width: fit-content; max-width: 100%; }
        @keyframes notification-fade { to { opacity: 0.95; transform: translateY(0); } }
        .notification.fade-out { animation: notification-fade-out 0.5s ease-in forwards; }
        @keyframes notification-fade-out { from { opacity: 0.95; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        .notification.notification-success { background-color: var(--color-primary); color: var(--color-white); }
        .notification.notification-error { background-color: var(--color-danger); color: var(--color-white); }
        .notification.notification-warning { background-color: var(--color-warning); color: var(--color-text-default); }
        .notification.notification-info { background-color: var(--color-info); color: var(--color-white); }
        body.dark-mode .notification.notification-warning { color: var(--color-text-default); }
        @media (max-width: 768px) { body { padding: var(--gap-lg); } .app { padding: var(--gap-lg); } .app-header { gap: var(--gap-md); } .search-container { max-width: none; } }
        @media (max-width: 600px) { h1 { font-size: var(--font-size-xxl); } h2 { font-size: var(--font-size-xl); } .app-header { flex-direction: column; align-items: flex-start; } .search-container { width: 100%; margin-right: 0; order: 3; } .theme-switch { position: absolute; top: var(--gap-lg); right: var(--gap-lg); } .filter-row { gap: var(--gap-md); } .filter-row > *, .sub-filter-group { width: 100%; min-width: 0; } #type-filter { width: 100%; } .bulk-action-btn { margin-left: 0; width: 100%; } .summary { flex-direction: column; align-items: stretch; gap: var(--gap-md); } .summary-item { text-align: left; display: flex; justify-content: space-between; padding: var(--gap-sm) 0; border-bottom: 1px solid var(--color-grey-border); } .summary-item:last-child { border-bottom: none; } .summary-item h3 { margin: 0; } .summary-item p { font-size: var(--font-size-md); } .transaction-list li { flex-direction: column; align-items: flex-start; gap: var(--gap-sm); } .transaction-right-col { flex-direction: row; align-items: center; justify-content: space-between; width: 100%; margin-left: 0; } .transaction-amount { margin-bottom: 0; font-size: var(--font-size-lg); } .transaction-note { font-size: var(--font-size-xs); } .modal-content { padding: var(--gap-lg); } }
        @media (max-width: 400px) { body { padding: var(--gap-sm); font-size: 13px; } .app { padding: var(--gap-md); } }
        #loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: var(--font-size-lg); color: var(--color-text-light); display: none; z-index: 10; }
        .transaction-list.loading #loading-indicator { display: block; }
    </style>
</head>
<body>
    <div id="notification-area"></div>

    <div class="app">
        <div class="app-header">
            <h1>💰 Shared Money Tracker</h1>
            <div class="search-container"> <input type="text" id="search-input" placeholder="Search..."> </div>
            <label class="theme-switch" for="theme-checkbox" title="Toggle Theme">
              <input type="checkbox" id="theme-checkbox">
              <span class="slider round"></span>
            </label>
        </div>

        <div class="tabs">
            <div class="tab tab-expense active" data-tab="expense">Add Expense</div>
            <div class="tab tab-income" data-tab="income">Add Income</div>
        </div>

        <div id="expense-form" class="form-container active">
             <select id="expense-user" class="user-selector" title="Select User"> </select>
             <input type="number" id="expense-amount" placeholder="Amount" step="0.01" min="0">
             <select id="expense-category" title="Select Category"> </select>
             <input type="date" id="expense-date" title="Select Date">
             <textarea id="expense-note" placeholder="Note (optional)" rows="2"></textarea>
             <button id="add-expense-btn">Add Expense</button>
        </div>

        <div id="income-form" class="form-container">
            <select id="income-user" class="user-selector" title="Select User"> </select>
            <input type="number" id="income-amount" placeholder="Amount" step="0.01" min="0">
            <select id="income-category" title="Select Category"> </select>
            <input type="date" id="income-date" title="Select Date">
            <textarea id="income-note" placeholder="Note (optional)" rows="2"></textarea>
            <button id="add-income-btn">Add Income</button>
        </div>

        <div class="filter-container">
            <div class="filter-row">
                <select class="filter-select" id="type-filter" title="Filter by Type"> <option value="all">All</option> <option value="income">Income</option> <option value="expense">Expense</option> </select>
                <button class="time-filter-btn" id="weekly-btn" data-filter="weekly" title="Filter by Week">Weekly</button>
                <button class="time-filter-btn" id="monthly-btn" data-filter="monthly" title="Filter by Month">Monthly</button>
                <button class="time-filter-btn" id="yearly-btn" data-filter="yearly" title="Filter by Year">Yearly</button>
            </div>
             <div class="filter-row">
                <label for="user-filter" style="font-size: var(--font-size-sm); margin-right: var(--gap-xs);">User:</label>
                <select class="filter-select" id="user-filter" title="Filter by User" style="width: auto; flex-grow: 1;"> </select>
            </div>
            <div class="filter-row">
                <input type="date" class="date-filter" id="date-filter" title="Filter by Specific Date">
                <button class="export-btn" id="export-btn" title="Export Data">Export</button>
                <button class="clear-btn" id="clear-filters-btn" title="Clear All Filters">Clear filter</button>
                <button id="bulk-delete-btn" class="bulk-action-btn" style="display: none;">Delete Selected</button>
            </div>
        </div>

        <div class="sub-filter-row" id="weekly-filters"> <div class="sub-filter-group"> <label>Week:</label> <select class="filter-select" id="week-select"> <option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option> <option value="4">Week 4</option><option value="5">Week 5+</option> </select> </div> <div class="sub-filter-group"> <label>Month:</label> <select class="filter-select" id="week-month-select"> <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option> <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option> </select> </div> <div class="sub-filter-group"> <label>Year:</label> <select class="filter-select" id="week-year-select"></select> </div> </div>
        <div class="sub-filter-row" id="monthly-filters"> <div class="sub-filter-group"> <label>Month:</label> <select class="filter-select" id="month-select"> <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option> <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option> </select> </div> <div class="sub-filter-group"> <label>Year:</label> <select class="filter-select" id="month-year-select"></select> </div> </div>
        <div class="sub-filter-row" id="yearly-filters"> <div class="sub-filter-group"> <label>Year:</label> <select class="filter-select" id="year-select"></select> </div> </div>

        <div class="summary">
            <div class="summary-item"> <h3 id="balance-label">Balance</h3> <p id="balance">$0.00</p> </div>
            <div class="summary-item"><h3>Income</h3><p id="income-total">$0.00</p></div>
            <div class="summary-item"><h3>Expenses</h3><p id="expenses-total">$0.00</p></div>
        </div>

        <div class="transaction-list-header">
            <h2>Transactions <small id="filter-display">(All)</small></h2>
            <div id="select-all-container">
                <input type="checkbox" id="select-all-checkbox" title="Select/Deselect All Visible">
                <label for="select-all-checkbox">Select All</label>
            </div>
        </div>
        <ul class="transaction-list" id="transaction-list">
             <div id="loading-indicator">Loading...</div>
             </ul>
    </div>

    <div id="edit-modal" class="modal"> <div class="modal-content"> <h3>Edit Transaction</h3> <input type="hidden" id="edit-id"><input type="hidden" id="edit-type"> <label for="edit-amount">Amount:</label><input type="number" id="edit-amount" placeholder="Amount" step="0.01" min="0"> <div id="edit-category-container"></div> <label for="edit-date">Date:</label><input type="date" id="edit-date"> <label for="edit-note">Note:</label><textarea id="edit-note" placeholder="Note" rows="2"></textarea> <div class="modal-actions"> <button class="cancel-btn" id="edit-cancel-btn">Cancel</button> <button id="edit-save-btn">Save</button> </div> </div> </div>
    <div id="delete-modal" class="modal"> <div class="modal-content"> <h3>Confirm Delete</h3> <p>Are you sure you want to delete this transaction?</p> <input type="hidden" id="delete-id"> <div class="modal-actions"> <button class="cancel-btn" id="delete-cancel-btn">No</button> <button class="confirm-btn" id="delete-confirm-btn">Yes</button> </div> </div> </div>
    <div id="bulk-delete-modal" class="modal"> <div class="modal-content"> <h3>Confirm Bulk Delete</h3> <p>Are you sure you want to delete the selected <span id="bulk-delete-count">0</span> transactions?</p> <div class="modal-actions"> <button class="cancel-btn" id="bulk-delete-cancel-btn">No</button> <button class="confirm-btn" id="bulk-delete-confirm-btn">Yes, Delete</button> </div> </div> </div>
    <div id="export-modal" class="modal"> <div class="modal-content"> <h3>Export Transactions</h3> <div class="export-options"> <label for="export-format">Format:</label> <select id="export-format"> <option value="csv">CSV</option> <option value="txt">TXT</option> <option value="json">JSON</option> </select> <label for="export-range">Range:</label> <select id="export-range"> <option value="all">All</option> <option value="current">Current Filtered</option> <option value="month">Specific Month</option> <option value="year">Specific Year</option> <option value="custom">Custom Range</option> </select> <div id="export-date-range-container" style="display: none; margin-top: 10px; display:flex; gap: 8px;"> <div style="flex: 1;"><label for="export-date-from">From:</label><input type="date" id="export-date-from"></div> <div style="flex: 1;"><label for="export-date-to">To:</label><input type="date" id="export-date-to"></div> </div> <div id="export-month-year-container" style="display: none; margin-top: 10px; display:flex; gap: 8px;"> <div style="flex: 1;"><label>Month:</label><select id="export-month-select"><option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option></select></div> <div style="flex: 1;"><label>Year:</label><select id="export-month-year-select"></select></div> </div> <div id="export-year-container" style="display: none; margin-top: 10px;"><label>Year:</label><select id="export-year-select"></select></div> </div> <div class="modal-actions"> <button class="cancel-btn" id="export-cancel-btn">Cancel</button> <button id="export-confirm-btn">Export</button> </div> </div> </div>


    <script>
        // --- Day.js Plugin Setup ---
        dayjs.extend(window.dayjs_plugin_customParseFormat); dayjs.extend(window.dayjs_plugin_isBetween); dayjs.extend(window.dayjs_plugin_isSameOrBefore); dayjs.extend(window.dayjs_plugin_isSameOrAfter); dayjs.extend(window.dayjs_plugin_utc); dayjs.extend(window.dayjs_plugin_timezone);

        // --- Application Configuration & Constants ---
        const AppConfig = {
            // !!! IMPORTANT: Using the NEW Web App URL from your latest deployment !!!
            apiUrl: 'https://script.google.com/macros/s/AKfycbxt79c6P-jUba9wRZSqWSOYOF5K032IVQVguw_VTdMUyMO1VK5jXyAQg0LumqQOIlQVlA/exec', // User Provided URL - UPDATED AGAIN!
            // apiSecret is NO LONGER NEEDED and has been removed.
            animationDuration: 400, staggerDelayIncrement: 50, notificationDuration: 3000, yearSelectorRange: 5,
            expenseCategories: ["Food & Drink", "Gas", "Personal Care", "Shopping", "Health Care", "Pay Loan", "Other"],
            incomeCategories: ["Salary", "Part-time", "Gift", "Loan", "Other"],
            users: ["Husband", "Wife"] // Keep this for dropdown population and filtering logic
        };

        // --- Global State Variables ---
        let transactions = []; // Holds all transactions fetched from backend
        let activeTimeFilter = null; // Tracks active time filter ('weekly', 'monthly', 'yearly')
        let currentlyDisplayedTransactions = []; // Holds transactions currently matching filters
        let selectedTransactionIds = new Set(); // Holds IDs of selected transactions for bulk actions
        let isLoading = false; // Tracks if data is currently being loaded/processed
        let currentUserRole = null; // Holds the role ('Husband', 'Wife') of the logged-in user

        // --- DOM Element Cache ---
        // (Keep the existing elements object the same)
        const elements = {
            expenseUser: document.getElementById('expense-user'), incomeUser: document.getElementById('income-user'), userFilter: document.getElementById('user-filter'), expenseAmount: document.getElementById('expense-amount'), expenseCategory: document.getElementById('expense-category'), expenseDate: document.getElementById('expense-date'), expenseNote: document.getElementById('expense-note'), addExpenseBtn: document.getElementById('add-expense-btn'), incomeAmount: document.getElementById('income-amount'), incomeCategory: document.getElementById('income-category'), incomeDate: document.getElementById('income-date'), incomeNote: document.getElementById('income-note'), addIncomeBtn: document.getElementById('add-income-btn'), transactionList: document.getElementById('transaction-list'), balanceLabel: document.getElementById('balance-label'), balanceDisplay: document.getElementById('balance'), incomeTotalDisplay: document.getElementById('income-total'), expensesTotalDisplay: document.getElementById('expenses-total'), filterDisplay: document.getElementById('filter-display'), typeFilter: document.getElementById('type-filter'), searchInput: document.getElementById('search-input'), dateFilter: document.getElementById('date-filter'), weeklyBtn: document.getElementById('weekly-btn'), monthlyBtn: document.getElementById('monthly-btn'), yearlyBtn: document.getElementById('yearly-btn'), clearFiltersBtn: document.getElementById('clear-filters-btn'), weekSelect: document.getElementById('week-select'), weekMonthSelect: document.getElementById('week-month-select'), weekYearSelect: document.getElementById('week-year-select'), monthSelect: document.getElementById('month-select'), monthYearSelect: document.getElementById('month-year-select'), yearSelect: document.getElementById('year-select'), editModal: document.getElementById('edit-modal'), editId: document.getElementById('edit-id'), editType: document.getElementById('edit-type'), editAmount: document.getElementById('edit-amount'), editCategoryContainer: document.getElementById('edit-category-container'), editDate: document.getElementById('edit-date'), editNote: document.getElementById('edit-note'), editSaveBtn: document.getElementById('edit-save-btn'), editCancelBtn: document.getElementById('edit-cancel-btn'), deleteModal: document.getElementById('delete-modal'), deleteId: document.getElementById('delete-id'), deleteConfirmBtn: document.getElementById('delete-confirm-btn'), deleteCancelBtn: document.getElementById('delete-cancel-btn'), exportModal: document.getElementById('export-modal'), exportBtn: document.getElementById('export-btn'), exportFormatSelect: document.getElementById('export-format'), exportRangeSelect: document.getElementById('export-range'), exportConfirmBtn: document.getElementById('export-confirm-btn'), exportCancelBtn: document.getElementById('export-cancel-btn'), exportDateFrom: document.getElementById('export-date-from'), exportDateTo: document.getElementById('export-date-to'), exportMonthSelect: document.getElementById('export-month-select'), exportMonthYearSelect: document.getElementById('export-month-year-select'), exportYearSelect: document.getElementById('export-year-select'), exportDateRangeContainer: document.getElementById('export-date-range-container'), exportMonthYearContainer: document.getElementById('export-month-year-container'), exportYearContainer: document.getElementById('export-year-container'), tabsContainer: document.querySelector('.tabs'), notificationArea: document.getElementById('notification-area'), selectAllCheckbox: document.getElementById('select-all-checkbox'), bulkDeleteBtn: document.getElementById('bulk-delete-btn'), bulkDeleteModal: document.getElementById('bulk-delete-modal'), bulkDeleteCount: document.getElementById('bulk-delete-count'), bulkDeleteConfirmBtn: document.getElementById('bulk-delete-confirm-btn'), bulkDeleteCancelBtn: document.getElementById('bulk-delete-cancel-btn'), themeCheckbox: document.getElementById('theme-checkbox'), loadingIndicator: document.getElementById('loading-indicator')
        };

        // --- SECTION: Initialization ---

        /**
         * Initializes the application: sets up theme, dropdowns, dates, listeners, and loads initial data.
         */
        async function initializeApp() {
            // Check if API URL is set (basic check)
            if (!AppConfig.apiUrl || AppConfig.apiUrl.includes('YOUR_DEPLOYED_APPS_SCRIPT_URL')) {
                showNotification('Error: API URL not configured correctly in HTML!', 'error', 10000);
                console.error("Configuration Error: Please verify `apiUrl` in AppConfig is set to your deployed script URL.");
                setLoadingState(false); // Ensure loading state is turned off
                return;
            }

            // Apply saved theme or default
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            // Populate dropdowns (users, categories)
            populateDropdowns();
            populateYearSelectors(); // Populate year selectors for filters/export

            // Set default dates for forms and filters
            setDefaultDatesAndFilters();

            // Set up all event listeners for buttons, inputs, etc.
            setupEventListeners();

            // Load initial transactions and user role from the backend
            await loadTransactions(); // This now also sets the user role and default forms

            // Update tab colors (visual)
            updateTabColors();
        }

        /**
         * Populates user and category dropdowns based on AppConfig.
         */
        function populateDropdowns() {
            const userSelects = [elements.expenseUser, elements.incomeUser, elements.userFilter];
            userSelects.forEach(select => {
                if (!select) return;
                const isFilter = select.id === 'user-filter';
                select.innerHTML = ''; // Clear existing options
                if (isFilter) {
                    // Add 'All Users' option only to the filter dropdown
                    select.appendChild(new Option('All Users', 'all'));
                }
                // Add users from config
                AppConfig.users.forEach(user => select.appendChild(new Option(user, user)));
            });

            // Populate expense categories
            const expenseCatSelect = elements.expenseCategory;
            expenseCatSelect.innerHTML = ''; // Clear existing
            AppConfig.expenseCategories.forEach(cat => expenseCatSelect.appendChild(new Option(cat, cat)));

            // Populate income categories
            const incomeCatSelect = elements.incomeCategory;
            incomeCatSelect.innerHTML = ''; // Clear existing
            AppConfig.incomeCategories.forEach(cat => incomeCatSelect.appendChild(new Option(cat, cat)));
        }

        // --- SECTION: State Management (API Interaction) ---

        /**
         * Toggles the loading state UI (disables inputs/buttons, shows indicator).
         * @param {boolean} loading - True to set loading state, false to remove it.
         */
        function setLoadingState(loading) {
            isLoading = loading;
            if (elements.transactionList) {
                elements.transactionList.classList.toggle('loading', loading);
            }
            // Disable/enable controls during loading, except modal cancel buttons and theme switch
            const controls = document.querySelectorAll('button, input, select, textarea');
            controls.forEach(control => {
                if (!control.closest('.modal-actions .cancel-btn') && control.id !== 'theme-checkbox') {
                    control.disabled = loading;
                }
            });
             // Ensure filter dropdowns are re-enabled if they were disabled
            if (!loading) {
                 if (elements.userFilter) elements.userFilter.disabled = false;
                 if (elements.typeFilter) elements.typeFilter.disabled = false;
                 // Add other filters if necessary
            }
        }

        /**
         * Loads transaction data and user role from the backend Google Apps Script.
         * Uses Google Sign-In authentication (no secret needed).
         * Updates the global transactions array and user role.
         * Sets the default user in forms based on the role.
         */
        async function loadTransactions() {
            if (isLoading) return; // Prevent concurrent loads
            setLoadingState(true);
            transactions = []; // Clear existing transactions
            currentUserRole = null; // Reset current user role

            try {
                // Fetch data from the NEW API URL (doGet). No secret or action needed in URL.
                const response = await fetch(AppConfig.apiUrl); // Simple GET request

                // Check if the response is OK (status 200-299)
                if (!response.ok) {
                    let errorMsg = `HTTP error! Status: ${response.status} ${response.statusText}`;
                    try {
                        // Try to parse error message from backend if available
                        const errorResult = await response.json();
                        errorMsg = errorResult.message || errorMsg;
                    } catch (e) {
                        // Ignore if parsing error response fails
                    }
                     // Handle specific case: 401/403 often mean authorization needed
                    if (response.status === 401 || response.status === 403) {
                         errorMsg += ". Please ensure you are logged into the correct Google account and have authorized the script.";
                    }
                    throw new Error(errorMsg);
                }

                // Parse the JSON response
                const result = await response.json();
                console.log("Raw result from API:", result); // Log for debugging

                // Check if the backend reported success and returned expected data structure
                if (result.status === 'success' && result.data && Array.isArray(result.data.transactions) && result.data.userRole) {
                    // Process transactions: format dates, parse numbers, ensure ID is string
                    transactions = result.data.transactions.map(item => {
                        let formattedDate = '';
                        if (item.Date) {
                            // Try parsing date, handle potential invalid dates from sheet
                            const dateObj = dayjs(item.Date);
                            formattedDate = dateObj.isValid() ? dateObj.format('YYYY-MM-DD') : '';
                        }
                        return {
                            ID: String(item.ID || Date.now() + Math.random()), // Ensure ID is string
                            Timestamp: parseInt(item.Timestamp) || dayjs(formattedDate).valueOf() || 0, // Parse timestamp or derive from date
                            Date: formattedDate,
                            Type: item.Type,
                            Amount: parseFloat(item.Amount) || 0, // Ensure amount is number
                            Category: item.Category,
                            Note: item.Note,
                            User: item.User // User set by backend
                        };
                    }).filter(t => isValidDate(t.Date)); // Filter out items with invalid dates

                    // Sort transactions by timestamp (newest first)
                    transactions.sort((a, b) => b.Timestamp - a.Timestamp);

                    // Store the logged-in user's role
                    currentUserRole = result.data.userRole;
                    console.log("Processed transactions array:", transactions);
                    console.log("Logged in user role:", currentUserRole);

                    // Set the default user in the forms based on the role
                    setDefaultUserForms(currentUserRole);

                } else {
                    // Handle cases where backend response format is unexpected
                    throw new Error(result.message || 'Invalid data format received from server.');
                }
            } catch (error) {
                console.error("Error loading transactions:", error);
                showNotification(`Error loading data: ${error.message}`, "error", 5000);
                transactions = []; // Ensure transactions array is empty on error
            } finally {
                setLoadingState(false); // Turn off loading indicator
                applyFiltersAndRender(); // Render whatever data we have (even if empty)
            }
        }

        /**
         * Adds a new transaction (expense or income) via the backend API.
         * @param {string} type - 'expense' or 'income'.
         */
        async function addTransaction(type) {
            if (isLoading) return; // Prevent action during loading

            // Get form elements based on type
            const userSelect = (type === 'expense') ? elements.expenseUser : elements.incomeUser;
            const amountInput = (type === 'expense') ? elements.expenseAmount : elements.incomeAmount;
            const categoryInput = (type === 'expense') ? elements.expenseCategory : elements.incomeCategory;
            const dateInput = (type === 'expense') ? elements.expenseDate : elements.incomeDate;
            const noteInput = (type === 'expense') ? elements.expenseNote : elements.incomeNote;

            // Get values from form
            const user = userSelect.value; // User selected in the form
            const amount = parseFloat(amountInput.value);
            const category = categoryInput.value || 'Uncategorized';
            const date = dateInput.value;
            const note = noteInput.value.trim();

            // Basic client-side validation
            if (!user) { showNotification('Please select a user.', 'error'); return; } // Should be pre-filled now, but keep check
            if (!amount || amount <= 0) { showNotification('Please enter a valid positive amount.', 'error'); return; }
            if (!date || !isValidDate(date)) { showNotification('Please select a valid date.', 'error'); return; }

            setLoadingState(true);

            // Prepare transaction data object to send
            // Note: Backend will set the 'User' field based on logged-in session,
            // but we include it here for completeness of the data object.
            // Backend also sets ID and potentially Timestamp.
            const transactionData = {
                // Timestamp: dayjs().valueOf(), // Backend can set this if needed
                Date: date,
                Type: type,
                Amount: amount,
                Category: category,
                Note: note,
                User: user // Frontend selected user (Backend enforces logged-in user role)
            };

            try {
                // Send POST request to the backend API (doPost)
                const response = await fetch(AppConfig.apiUrl, {
                    method: 'POST',
                    mode: 'cors', // Necessary for cross-origin requests
                    cache: 'no-cache',
                    headers: {
                        // Apps Script doPost often expects text/plain when receiving JSON string
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    // Send action and data in the body (NO secret)
                    body: JSON.stringify({
                        action: 'addTransaction',
                        data: transactionData
                    })
                });

                if (!response.ok) {
                    let errorMsg = `HTTP error! ${response.status}`;
                    try { const errRes = await response.json(); errorMsg = errRes.message || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    // Add the new transaction (returned from backend with final ID/User) to the local array
                    const newTx = {
                        ...result.data,
                        ID: String(result.data.ID), // Ensure ID is string
                        Timestamp: parseInt(result.data.Timestamp) || 0, // Ensure timestamp is number
                        Amount: parseFloat(result.data.Amount) || 0, // Ensure amount is number
                    };
                    transactions.unshift(newTx); // Add to beginning
                    transactions.sort((a, b) => b.Timestamp - a.Timestamp); // Re-sort

                    showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} added!`, 'success');

                    // Reset form fields
                    amountInput.value = '';
                    noteInput.value = '';
                    dateInput.value = dayjs().format('YYYY-MM-DD'); // Reset date to today
                    categoryInput.selectedIndex = 0; // Reset category dropdown
                    // User dropdown remains as the logged-in user

                } else {
                    throw new Error(result.message || `Failed to add ${type}.`);
                }
            } catch (error) {
                console.error(`Error adding ${type}:`, error);
                showNotification(`Error adding ${type}: ${error.message}`, "error", 5000);
            } finally {
                setLoadingState(false);
                applyFiltersAndRender(); // Update the UI
            }
        }

        /**
         * Saves edits to an existing transaction via the backend API.
         */
        async function saveEditedTransaction() {
            if (isLoading) return;

            // Get data from the edit modal form
            const id = elements.editId.value; // Transaction ID to edit
            const amount = parseFloat(elements.editAmount.value);
            const categorySelect = document.getElementById('edit-category-select'); // Dynamic element
            const category = categorySelect ? categorySelect.value : 'Uncategorized';
            const date = elements.editDate.value;
            const note = elements.editNote.value.trim();

            // Validation
            if (!id) { showNotification('Error: Transaction ID missing.', 'error'); return; }
            if (!amount || amount <= 0) { showNotification('Please enter a valid positive amount.', 'error'); return; }
            if (!date || !isValidDate(date)) { showNotification('Please select a valid date.', 'error'); return; }

            setLoadingState(true);

            // Prepare data object with only the fields that can be edited
            const updatedData = {
                ID: id,
                Amount: amount,
                Category: category,
                Date: date,
                Note: note
                // Note: 'User' and 'Type' are typically not editable here. Backend enforces user.
            };

            try {
                // Send POST request to the backend API (doPost)
                const response = await fetch(AppConfig.apiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    // Send action and data (NO secret)
                    body: JSON.stringify({
                        action: 'editTransaction',
                        data: updatedData
                    })
                });

                if (!response.ok) {
                    let errorMsg = `HTTP error! ${response.status}`;
                    try { const errRes = await response.json(); errorMsg = errRes.message || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    // Find the index of the edited transaction in the local array
                    const index = transactions.findIndex(t => String(t.ID) === id);
                    if (index !== -1) {
                        // Update the local transaction data with the data returned from backend
                         const updatedTx = {
                            ...result.data,
                            ID: String(result.data.ID), // Ensure ID is string
                            Timestamp: parseInt(result.data.Timestamp) || 0, // Ensure timestamp is number
                            Amount: parseFloat(result.data.Amount) || 0, // Ensure amount is number
                        };
                        transactions[index] = updatedTx;
                        transactions.sort((a, b) => b.Timestamp - a.Timestamp); // Re-sort if date/timestamp logic changes
                    }
                    showNotification('Transaction updated!', 'success');
                    closeModal(); // Close the edit modal
                } else {
                    throw new Error(result.message || 'Failed to update transaction.');
                }
            } catch (error) {
                console.error("Error updating transaction:", error);
                showNotification(`Update Error: ${error.message}`, 'error', 5000);
            } finally {
                setLoadingState(false);
                applyFiltersAndRender(); // Update the UI
            }
        }

        /**
         * Confirms and deletes a transaction via the backend API.
         */
        async function confirmDelete() {
            if (isLoading) return;

            const id = elements.deleteId.value; // Get ID from the delete confirmation modal
            if (!id) return;

            setLoadingState(true);

            try {
                // Send POST request to the backend API (doPost)
                const response = await fetch(AppConfig.apiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    // Send action and data (ID) (NO secret)
                    body: JSON.stringify({
                        action: 'deleteTransaction',
                        data: { ID: id }
                    })
                });

                if (!response.ok) {
                    let errorMsg = `HTTP error! ${response.status}`;
                    try { const errRes = await response.json(); errorMsg = errRes.message || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }

                const result = await response.json();

                // Check if backend confirmed deletion of the correct ID
                if (result.status === 'success' && result.data && String(result.data.ID) === id) {
                    // Remove the transaction from the local array
                    transactions = transactions.filter(t => String(t.ID) !== id);
                    selectedTransactionIds.delete(id); // Remove from selection if present

                    showNotification('Transaction deleted.', 'info');
                    closeModal(); // Close the delete confirmation modal
                } else {
                    throw new Error(result.message || 'Failed to delete transaction.');
                }
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showNotification(`Delete Error: ${error.message}`, 'error', 5000);
            } finally {
                setLoadingState(false);
                applyFiltersAndRender(); // Update the UI
            }
        }

        /**
         * Handles the confirmation of bulk delete.
         * NOTE: Requires corresponding 'bulkDeleteTransaction' action implemented in Apps Script.
         */
        async function handleBulkDeleteConfirm() {
            const idsToDelete = Array.from(selectedTransactionIds);
            if (idsToDelete.length === 0 || isLoading) return;

            // --- Placeholder for Bulk Delete ---
            // TODO: Implement 'bulkDeleteTransaction' action in Google Apps Script.
            // This action should accept an array of IDs and delete them efficiently.
            showNotification(`Bulk Delete (${idsToDelete.length} items) needs API update.`, 'warning');
            console.warn("Bulk delete action not implemented in backend script.");
            closeModal(); // Close the bulk delete modal for now
            setLoadingState(false); // Ensure loading is off
            // applyFiltersAndRender(); // Re-render might be needed if simulating deletion locally

            /* --- Example of how bulk delete *might* work (requires backend changes) ---
            setLoadingState(true);
            try {
                const response = await fetch(AppConfig.apiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'bulkDeleteTransaction', // Needs implementation in Apps Script
                        data: { IDs: idsToDelete }
                    })
                });
                if (!response.ok) { // ... error handling ... }
                const result = await response.json();
                if (result.status === 'success' && result.data && result.data.deletedCount > 0) {
                    // Remove deleted items from local state
                    transactions = transactions.filter(t => !selectedTransactionIds.has(String(t.ID)));
                    selectedTransactionIds.clear();
                    showNotification(`${result.data.deletedCount} transactions deleted.`, 'info');
                    closeModal();
                } else { // ... error handling ... }
            } catch (error) { // ... error handling ... }
            finally { setLoadingState(false); applyFiltersAndRender(); }
            */
        }

        // --- SECTION: UI Rendering & Updates ---

        /**
         * Renders the list of transactions with animations.
         * @param {Array<Object>} dataToRender - The array of transactions to display.
         */
        function renderTransactions(dataToRender) {
            // Show loading indicator if loading and list is empty
            if (isLoading && dataToRender.length === 0) {
                elements.transactionList.innerHTML = ''; // Clear list
                elements.transactionList.appendChild(elements.loadingIndicator); // Show loading
                return;
            }
            // Remove loading indicator if it's present
            if (elements.loadingIndicator.parentNode === elements.transactionList) {
                elements.transactionList.removeChild(elements.loadingIndicator);
            }

            const list = elements.transactionList;
            const idsToRender = new Set(dataToRender.map(t => String(t.ID))); // IDs of items that should be visible
            const { animationDuration: duration, staggerDelayIncrement: increment } = AppConfig;

            // --- FLIP Animation Setup ---
            const firstPositions = new Map(); // Store initial positions of existing items
            const firstScroll = list.scrollTop; // Store initial scroll position
            const existingElements = list.querySelectorAll('li[data-id]:not(.transaction-list-item--removing)'); // Get current items not already animating out
            const existingIds = new Set();
            const existingMap = new Map(); // Map ID to existing element

            existingElements.forEach(el => {
                const id = el.dataset.id;
                existingIds.add(id);
                firstPositions.set(id, el.getBoundingClientRect()); // Record position relative to viewport
                existingMap.set(id, el);
            });

            // --- Determine Entering, Moving, Leaving Elements ---
            const fragment = document.createDocumentFragment();
            const entering = []; // New items to add
            const moving = [];   // Existing items that remain
            const leaving = [];  // Existing items to remove

            // Identify leaving elements
            existingElements.forEach(el => {
                if (!idsToRender.has(el.dataset.id)) {
                    leaving.push(el);
                }
            });

            // Process data to render: identify moving and entering elements
            dataToRender.forEach(t => {
                const id = String(t.ID);
                if (existingIds.has(id)) {
                    // Item already exists, it's moving (or staying)
                    const el = existingMap.get(id);
                    if (el) {
                        // Update selection state before adding to fragment
                        updateListItemSelection(el, selectedTransactionIds.has(id));
                        moving.push(el);
                        fragment.appendChild(el); // Re-add to fragment in the new order
                        el.classList.remove('transaction-list-item--removing'); // Ensure it's not marked for removal
                    }
                } else {
                    // Item is new, it's entering
                    const li = createTransactionListItem(t); // Create new list item element
                    li.style.opacity = '0'; // Start invisible for fade-in
                    entering.push(li);
                    fragment.appendChild(li); // Add to fragment
                }
            });

            // --- Prepare Animations ---
            // Position leaving elements absolutely where they were
            positionLeavingElements(leaving, firstPositions, list, firstScroll);

            // Update the DOM with the new arrangement (without leaving elements initially)
            list.innerHTML = '';
            list.appendChild(fragment);

            // Re-add leaving elements to the list so they can be animated out
            leaving.forEach(el => {
                if (el.style.position === 'absolute') { // Only add if positioned
                    list.appendChild(el);
                }
            });

            // Record final positions of moving/entering elements
            const lastScroll = list.scrollTop;
            const lastPositions = recordLastPositions(list, leaving);

            // Invert positions for moving elements (apply transform to make them appear in old position)
            invertMovingElements(moving, firstPositions, lastPositions, firstScroll, lastScroll);

            // Play animations (move elements to final position, fade in/out)
            playAnimations(moving, entering, leaving, list, duration, increment);

            // Update global state and UI elements related to bulk actions
            currentlyDisplayedTransactions = dataToRender;
            updateBulkActionUI();
        }

        /**
         * Creates an HTML list item element for a transaction.
         * @param {Object} t - The transaction object.
         * @returns {HTMLLIElement} The created list item element.
         */
        function createTransactionListItem(t) {
            const li = document.createElement('li');
            const id = String(t.ID);
            const isSelected = selectedTransactionIds.has(id);
            const type = t.Type === 'income' || t.Type === 'expense' ? t.Type : 'unknown';
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);

            li.className = `${type}${isSelected ? ' selected' : ''}`; // Add type and selected class
            li.dataset.id = id; // Store ID on the element

            // Format date and time using dayjs
            const displayDate = dayjs(t.Date).format('MMM D, YYYY'); // Corrected format
            const displayTime = dayjs(t.Timestamp).format('h:mm a');

            // Create badge based on type
            const badge = `<span class="type-badge ${type}">${typeLabel}</span>`;
            // Display user who added it
            const userDisplay = `<div class="transaction-user">By: ${escapeHTML(t.User || '?')}</div>`;
            // Display note if present
            const noteDisplay = t.Note ? `<div class="transaction-note">${escapeHTML(t.Note)}</div>` : '';

            // Construct inner HTML
            li.innerHTML = `
                <div class="transaction-checkbox-container">
                    <input type="checkbox" class="transaction-checkbox" data-id="${id}" ${isSelected ? 'checked' : ''} aria-label="Select transaction">
                </div>
                <div class="transaction-info">
                    <div class="transaction-header">
                        ${badge}
                        <span class="transaction-category">${escapeHTML(t.Category || 'N/A')}</span>
                    </div>
                    <div class="transaction-details">
                        ${displayDate} <span class="transaction-time">(${displayTime})</span>
                    </div>
                    ${userDisplay}
                    ${noteDisplay}
                </div>
                <div class="transaction-right-col">
                    <div class="transaction-amount">${type === 'income' ? '+' : '-'}${formatCurrency(t.Amount)}</div>
                    <div class="transaction-actions">
                        <button class="action-btn edit-btn" title="Edit">✏️</button>
                        <button class="action-btn delete-btn" title="Delete">🗑️</button>
                    </div>
                </div>`;
            return li;
        }

        /**
         * Updates the visual selection state of a list item and the global selection set.
         * @param {HTMLLIElement} el - The list item element.
         * @param {boolean} isSelected - Whether the item should be marked as selected.
         */
        function updateListItemSelection(el, isSelected) {
            if (!el || !el.dataset || !el.dataset.id) return; // Basic validation
            const id = el.dataset.id;
            const checkbox = el.querySelector('.transaction-checkbox');

            if (isSelected) {
                el.classList.add('selected');
                selectedTransactionIds.add(id);
                if (checkbox) checkbox.checked = true;
            } else {
                el.classList.remove('selected');
                selectedTransactionIds.delete(id);
                if (checkbox) checkbox.checked = false;
            }
        }

        // --- FLIP Animation Helper Functions ---

        /** Positions leaving elements absolutely based on their initial position. */
        function positionLeavingElements(leaving, firstPositions, listElement, firstScroll) {
            leaving.forEach(el => {
                const first = firstPositions.get(el.dataset.id);
                if (first) {
                    el.style.position = 'absolute';
                    const listRect = listElement.getBoundingClientRect();
                    // Calculate position relative to the list container, considering scroll
                    el.style.top = `${first.top - listRect.top + firstScroll}px`;
                    el.style.left = `${first.left - listRect.left}px`;
                    el.style.width = `${first.width}px`; // Maintain width
                    el.style.zIndex = '-1'; // Place behind other items during animation
                }
            });
        }

        /** Records the final positions of elements currently in the list. */
        function recordLastPositions(listElement, leaving) {
            const lastPositions = new Map();
            const leavingIds = new Set(leaving.map(el => el.dataset.id));
            const allCurrentItems = listElement.querySelectorAll('li[data-id]');

            allCurrentItems.forEach(el => {
                // Only record position if it's not a leaving element
                if (!leavingIds.has(el.dataset.id)) {
                    lastPositions.set(el.dataset.id, el.getBoundingClientRect());
                }
            });
            return lastPositions;
        }

        /** Calculates and applies initial transform to moving elements to make them appear in their old position. */
        function invertMovingElements(moving, firstPositions, lastPositions, firstScroll, lastScroll) {
            moving.forEach(el => {
                const id = el.dataset.id;
                const first = firstPositions.get(id);
                const last = lastPositions.get(id);

                if (first && last) {
                    // Calculate the difference in position, accounting for scroll changes
                    const deltaX = Math.round(first.left - last.left);
                    const deltaY = Math.round((first.top + firstScroll) - (last.top + lastScroll));

                    // Apply inverse transform if moved significantly
                    if (Math.abs(deltaX) > 0.5 || Math.abs(deltaY) > 0.5) {
                        el.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                    } else {
                        el.style.transform = ''; // No significant move, clear transform
                    }
                    el.style.opacity = '1'; // Ensure moving items are visible
                }
            });
        }

        /** Plays the actual CSS transitions/animations. */
        function playAnimations(moving, entering, leaving, listElement, duration, increment) {
            // Use requestAnimationFrame to ensure styles are applied before starting transitions
            requestAnimationFrame(() => {
                const baseTransition = `transform ${duration}ms ease-in-out, opacity ${duration}ms ease-in-out`;

                // Animate moving elements to their final position (remove transform)
                moving.forEach(el => {
                    el.style.transition = baseTransition;
                    el.style.transform = ''; // Animate back to natural position
                    el.style.opacity = '1';
                    // Clean up transition style after animation ends
                    el.addEventListener('transitionend', () => { el.style.transition = ''; }, { once: true });
                });

                // Animate entering elements (fade in) with stagger
                entering.forEach((el, i) => {
                    const delay = i * increment;
                    el.style.transition = `opacity ${duration}ms ease-in-out ${delay}ms`;
                    el.style.opacity = '1'; // Fade in
                    el.addEventListener('transitionend', () => { el.style.transition = ''; }, { once: true });
                });

                // Animate leaving elements (fade out) with stagger
                leaving.forEach((el, i) => {
                    const delay = i * increment;
                    el.style.transition = `opacity ${duration}ms ease-in-out ${delay}ms`;
                    el.classList.add('transaction-list-item--removing'); // Apply fade-out class/style
                    el.style.opacity = '0'; // Fade out
                    const totalDuration = duration + delay;
                    // Remove element from DOM after animation completes
                    setTimeout(() => {
                        if (el.parentNode === listElement) {
                            listElement.removeChild(el);
                        }
                    }, totalDuration);
                });

                // Handle showing/hiding the "No transactions" message
                handleEmptyListState(listElement, moving, entering, leaving, duration, increment);
            });
        }

        /** Shows or hides the "No transactions" message based on list content and animations. */
        function handleEmptyListState(listElement, moving, entering, leaving, duration, increment) {
            const emptyMessageHTML = '<div class="no-transactions">No transactions match filters.</div>';
            const hasContentNow = moving.length > 0 || entering.length > 0;

            if (leaving.length > 0) {
                // If items are leaving, wait until the last one finishes animating
                const maxDelay = (leaving.length - 1) * increment;
                const timeToRemove = duration + maxDelay;
                setTimeout(() => {
                    const remainingItems = listElement.querySelectorAll('li[data-id]:not(.transaction-list-item--removing)');
                    if (remainingItems.length === 0 && !listElement.querySelector('.no-transactions')) {
                        // If list is empty after animation, show message
                        listElement.innerHTML = emptyMessageHTML;
                    } else if (remainingItems.length > 0) {
                        // If list has items, remove any existing empty message
                        const emptyMsgElement = listElement.querySelector('.no-transactions');
                        if (emptyMsgElement) listElement.removeChild(emptyMsgElement);
                    }
                }, timeToRemove + 50); // Add slight buffer
            } else if (!hasContentNow) {
                // If no items entered or moved, and none were leaving, show message immediately if needed
                if (!listElement.querySelector('.no-transactions')) {
                    listElement.innerHTML = emptyMessageHTML;
                }
            } else {
                // If there is content, remove any existing empty message
                const emptyMsgElement = listElement.querySelector('.no-transactions');
                if (emptyMsgElement) listElement.removeChild(emptyMsgElement);
            }
        }

        /**
         * Updates the summary section (Balance, Income, Expenses).
         * @param {Array<Object>} data - The array of transactions to summarize.
         */
        function updateSummary(data) {
            const incomeTotal = data.filter(t => t.Type === 'income').reduce((sum, t) => sum + t.Amount, 0);
            const expensesTotal = data.filter(t => t.Type === 'expense').reduce((sum, t) => sum + t.Amount, 0);
            const balance = incomeTotal - expensesTotal;

            elements.incomeTotalDisplay.textContent = formatCurrency(incomeTotal);
            elements.expensesTotalDisplay.textContent = formatCurrency(expensesTotal);
            elements.balanceDisplay.textContent = formatCurrency(balance);
            // Change balance color based on positive/negative
            elements.balanceDisplay.style.color = balance < 0 ? 'var(--color-danger)' : 'var(--color-primary)';
        }

        /** Updates the text display indicating the current filters applied. */
        function updateFilterDisplay() {
            let filterText = 'All';
            const type = elements.typeFilter.value;
            const dateVal = elements.dateFilter.value;
            const search = elements.searchInput.value.trim();
            const user = elements.userFilter.value;
            let isFiltered = false;

            // Check time period filters first
            if (activeTimeFilter) {
                isFiltered = true;
                if (activeTimeFilter === 'weekly') {
                    filterText = `Week ${elements.weekSelect.value}, ${elements.weekMonthSelect.options[elements.weekMonthSelect.selectedIndex].text} ${elements.weekYearSelect.value}`;
                } else if (activeTimeFilter === 'monthly') {
                    filterText = `${elements.monthSelect.options[elements.monthSelect.selectedIndex].text} ${elements.monthYearSelect.value}`;
                } else if (activeTimeFilter === 'yearly') {
                    filterText = `Year ${elements.yearSelect.value}`;
                }
            } else if (dateVal && isValidDate(dateVal)) {
                // Check specific date filter if no time period is active
                isFiltered = true;
                filterText = dayjs(dateVal).format('MMM D, YYYY');
            }

            // Append other filters
            if (type !== 'all') {
                filterText = isFiltered ? `${filterText} (${type})` : type.charAt(0).toUpperCase() + type.slice(1);
                isFiltered = true;
            }
            if (user !== 'all') {
                filterText = isFiltered ? `${filterText} (User: ${user})` : `User: ${user}`;
                isFiltered = true;
            }
            if (search) {
                filterText = isFiltered ? `${filterText} (Search: "${search}")` : `Search: "${search}"`;
                isFiltered = true;
            }

            if (!isFiltered) filterText = 'All'; // Reset to 'All' if no filters applied

            elements.filterDisplay.textContent = `(${filterText})`;

            // Adjust Balance label based on type filter
            elements.balanceLabel.textContent = (type === 'income' || type === 'expense') ? 'Total' : 'Balance';
        }

        /** Switches between the 'Add Expense' and 'Add Income' tabs/forms. */
        function switchTab(tabName) {
            // Deactivate all tabs and forms
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));

            // Activate the selected tab and form
            document.querySelector(`.tab[data-tab='${tabName}']`)?.classList.add('active');
            document.getElementById(`${tabName}-form`)?.classList.add('active');

            updateTabColors(); // Update visual style if needed
        }

        /** Updates tab colors (handled by CSS, but function exists if needed). */
        function updateTabColors() { /* CSS handles this */ }

        /** Shows a notification message at the top of the screen. */
        function showNotification(message, type = 'info', duration = AppConfig.notificationDuration) {
            if (!elements.notificationArea) return;
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`; // e.g., notification-success
            notification.textContent = message;

            elements.notificationArea.appendChild(notification);

            // Automatically remove after duration
            setTimeout(() => {
                notification.classList.add('fade-out');
                // Remove from DOM after fade-out animation completes
                notification.addEventListener('animationend', () => {
                    if (notification.parentNode === elements.notificationArea) {
                        elements.notificationArea.removeChild(notification);
                    }
                }, { once: true });
            }, duration);
        }

        /** Applies the selected theme (light/dark) to the body. */
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                if (elements.themeCheckbox) elements.themeCheckbox.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                if (elements.themeCheckbox) elements.themeCheckbox.checked = false;
            }
        }

        // --- SECTION: Filtering Logic ---

        /** Applies all active filters to the global transactions array and triggers rendering. */
        function applyFiltersAndRender() {
            selectedTransactionIds.clear(); // Clear selection when filters change

            const type = elements.typeFilter.value;
            const dateVal = elements.dateFilter.value;
            const search = elements.searchInput.value.toLowerCase().trim();
            const user = elements.userFilter.value;

            let filteredTransactions = [...transactions]; // Start with all transactions

            // Apply type filter
            if (type !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.Type === type);
            }

            // Apply user filter
            if (user !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.User === user);
            }

            // Apply search filter (checks category, note, amount, date string, user)
            if (search) {
                filteredTransactions = filteredTransactions.filter(t =>
                    (t.Category?.toLowerCase().includes(search) ||
                     (t.Note && t.Note.toLowerCase().includes(search)) ||
                     t.Amount.toString().includes(search) || // Simple amount check
                     t.Date.includes(search) || // Check if date string contains search term
                     t.User?.toLowerCase().includes(search)
                    )
                );
            }

            // Apply time period filter OR specific date filter (not both)
            if (activeTimeFilter) {
                filteredTransactions = applyTimePeriodFilter(filteredTransactions, activeTimeFilter);
            } else if (dateVal && isValidDate(dateVal)) {
                const targetDate = dayjs(dateVal);
                filteredTransactions = filteredTransactions.filter(t => dayjs(t.Date).isSame(targetDate, 'day'));
            }

            // Render the filtered list and update summary/display
            renderTransactions(filteredTransactions);
            updateSummary(filteredTransactions);
            updateFilterDisplay();
        }

        /** Filters data based on the selected time period (Weekly, Monthly, Yearly). */
        function applyTimePeriodFilter(data, filterType) {
            switch (filterType) {
                case 'weekly':
                    const weekYear = parseInt(elements.weekYearSelect.value);
                    const weekMonth = parseInt(elements.weekMonthSelect.value);
                    const weekNum = parseInt(elements.weekSelect.value);
                    const { start, end } = getWeekDates(weekYear, weekMonth, weekNum);
                    // Filter if start and end dates are valid
                    return (start && end) ? data.filter(t => dayjs(t.Date).isBetween(start, end, 'day', '[]')) : []; // '[]' includes start/end days
                case 'monthly':
                    const month = parseInt(elements.monthSelect.value) - 1; // dayjs months are 0-indexed
                    const monthYear = parseInt(elements.monthYearSelect.value);
                    return data.filter(t => {
                        const date = dayjs(t.Date);
                        return date.year() === monthYear && date.month() === month;
                    });
                case 'yearly':
                    const year = parseInt(elements.yearSelect.value);
                    return data.filter(t => dayjs(t.Date).year() === year);
                default:
                    return data; // No valid time filter applied
            }
        }

        /** Calculates the start and end dates for a given week number within a month/year. */
        function getWeekDates(year, month, weekNum) {
            const monthIndex = month - 1; // dayjs months are 0-indexed
            const firstOfMonth = dayjs().year(year).month(monthIndex).startOf('month');
            const lastOfMonth = firstOfMonth.endOf('month');

            if (!firstOfMonth.isValid()) return { start: null, end: null }; // Invalid year/month input

            let weekStart, weekEnd;

            if (weekNum === 1) {
                // First week starts on the 1st, ends 6 days later or end of month, whichever is sooner
                weekStart = firstOfMonth;
                weekEnd = firstOfMonth.add(6, 'day');
            } else {
                // Calculate start based on offset (weekNum - 1) * 7 days
                const dayOffset = (weekNum - 1) * 7;
                weekStart = firstOfMonth.add(dayOffset, 'day');
                // Ensure start date is still within the correct month
                if (weekStart.month() !== monthIndex) {
                     // Handle week 5+ case: If calculated start is in next month, it means week 5 starts
                     // somewhere in the last days of the target month. Calculate from end of month.
                     if (weekNum >= 5) {
                         // Start of the last week (e.g., Sunday/Monday before end of month)
                         weekStart = lastOfMonth.startOf('week'); // Adjust based on locale start of week if needed
                         // If startOf('week') goes back to previous month, clamp to first of month
                         if (weekStart.month() !== monthIndex) weekStart = firstOfMonth;
                     } else {
                         // Weeks 2, 3, 4 should not start in the next month
                         return { start: null, end: null }; // Invalid week for this month
                     }
                }
                 weekEnd = weekStart.add(6, 'day');
            }

            // Clamp end date to the end of the month
            if (weekEnd.isAfter(lastOfMonth)) {
                weekEnd = lastOfMonth;
            }
             // Ensure start is not after end (can happen in edge cases with short months/week 5)
             if (weekStart.isAfter(weekEnd)) {
                 // If week 5+ calculation resulted in start after end, adjust start to beginning of last week
                 weekStart = lastOfMonth.startOf('week');
                 if (weekStart.month() !== monthIndex) weekStart = firstOfMonth;
                 if (weekStart.isAfter(weekEnd)) return { start: null, end: null }; // Still invalid
             }


            // Return start and end of the day for accurate comparison
            return { start: weekStart.startOf('day'), end: weekEnd.endOf('day') };
        }

        // --- SECTION: Event Handling ---

        /** Sets up all initial event listeners for the application. */
        function setupEventListeners() {
            // Form Submissions
            elements.addExpenseBtn.addEventListener('click', () => addTransaction('expense'));
            elements.addIncomeBtn.addEventListener('click', () => addTransaction('income'));

            // Tabs
            elements.tabsContainer.addEventListener('click', handleTabClick);

            // Filters
            elements.userFilter.addEventListener('change', applyFiltersAndRender);
            elements.searchInput.addEventListener('input', applyFiltersAndRender); // Use input for real-time search
            elements.typeFilter.addEventListener('change', applyFiltersAndRender);
            elements.dateFilter.addEventListener('change', handleDateFilterChange);
            elements.clearFiltersBtn.addEventListener('click', handleClearFilters);

            // Time Period Filters
            elements.weeklyBtn.addEventListener('click', () => handleTimeFilterToggle('weekly'));
            elements.monthlyBtn.addEventListener('click', () => handleTimeFilterToggle('monthly'));
            elements.yearlyBtn.addEventListener('click', () => handleTimeFilterToggle('yearly'));
            // Sub-filter dropdown changes
            [elements.weekSelect, elements.weekMonthSelect, elements.weekYearSelect,
             elements.monthSelect, elements.monthYearSelect, elements.yearSelect]
             .forEach(select => select.addEventListener('change', applyFiltersAndRender));

            // Transaction List Actions (Edit/Delete/Select) - Use event delegation
            elements.transactionList.addEventListener('click', handleTransactionListClick);
            elements.transactionList.addEventListener('change', handleTransactionListChange); // For checkboxes

            // Bulk Actions
            elements.selectAllCheckbox.addEventListener('change', handleSelectAllChange);
            elements.bulkDeleteBtn.addEventListener('click', openBulkDeleteModal);

            // Modals
            elements.editSaveBtn.addEventListener('click', saveEditedTransaction);
            elements.deleteConfirmBtn.addEventListener('click', confirmDelete);
            elements.bulkDeleteConfirmBtn.addEventListener('click', handleBulkDeleteConfirm);
            // Cancel buttons for all modals
            [elements.editCancelBtn, elements.deleteCancelBtn, elements.exportCancelBtn, elements.bulkDeleteCancelBtn]
             .forEach(button => button.addEventListener('click', closeModal));

            // Export
            elements.exportBtn.addEventListener('click', openExportModal);
            elements.exportConfirmBtn.addEventListener('click', exportData);
            elements.exportRangeSelect.addEventListener('change', toggleExportDateRangePicker);

            // Theme Toggle
            elements.themeCheckbox.addEventListener('change', handleThemeToggle);
        }

        /** Handles clicks within the tabs container to switch tabs. */
        function handleTabClick(event) {
            const tabElement = event.target.closest('.tab');
            if (tabElement && tabElement.dataset.tab) {
                switchTab(tabElement.dataset.tab);
            }
        }

        /** Handles changes to the specific date filter input. */
        function handleDateFilterChange() {
            // If a time period filter was active, deactivate it
            if (activeTimeFilter) {
                activeTimeFilter = null;
                clearActiveTimeFilterButton();
                hideSubFilterRows();
            }
            applyFiltersAndRender(); // Apply the new date filter
        }

        /** Clears all filters and resets the view. */
        function handleClearFilters() {
            // Reset filter inputs
            elements.typeFilter.value = 'all';
            elements.dateFilter.value = '';
            elements.searchInput.value = '';
            elements.userFilter.value = 'all'; // Reset user filter

            // Deactivate time period filters
            activeTimeFilter = null;
            clearActiveTimeFilterButton();
            hideSubFilterRows();

            // Reset sub-filter dropdowns to default (current date)
            setDefaultDatesAndFilters(); // Resets week/month/year selects

            // Apply cleared filters and re-render
            applyFiltersAndRender();
        }

        /** Toggles the active state of time period filters (Weekly, Monthly, Yearly). */
        function handleTimeFilterToggle(type) {
            hideSubFilterRows(); // Hide all sub-filter rows first

            if (activeTimeFilter === type) {
                // If clicking the already active filter, deactivate it
                activeTimeFilter = null;
                clearActiveTimeFilterButton();
            } else {
                // Activate the new filter
                activeTimeFilter = type;
                clearActiveTimeFilterButton(); // Deactivate others
                document.getElementById(`${type}-btn`).classList.add('active'); // Highlight active button
                document.getElementById(`${type}-filters`).style.display = 'flex'; // Show relevant sub-filters
                elements.dateFilter.value = ''; // Clear specific date filter when using time period
            }
            applyFiltersAndRender(); // Apply the change
        }

        /** Handles clicks within the transaction list (for edit/delete buttons). */
        function handleTransactionListClick(event) {
            const editButton = event.target.closest('.edit-btn');
            const deleteButton = event.target.closest('.delete-btn');
            const listItem = event.target.closest('li[data-id]');

            if (!listItem) return; // Click was not on a list item or its contents

            const transactionId = listItem.dataset.id;

            if (editButton) {
                openEditModal(transactionId);
            } else if (deleteButton) {
                openDeleteModal(transactionId);
            }
            // Checkbox clicks are handled by handleTransactionListChange
        }

        /** Handles changes to checkboxes within the transaction list. */
        function handleTransactionListChange(event) {
            const checkbox = event.target.closest('.transaction-checkbox');
            const listItem = event.target.closest('li[data-id]');

            // Ensure the change event came from a transaction checkbox within a list item
            if (checkbox && listItem && checkbox.id !== 'select-all-checkbox') {
                const transactionId = listItem.dataset.id;
                updateListItemSelection(listItem, checkbox.checked); // Update selection state
                updateBulkActionUI(); // Update bulk action button visibility/state
            }
        }

        /** Handles changes to the 'Select All' checkbox. */
        function handleSelectAllChange() {
            const isChecked = elements.selectAllCheckbox.checked;
            // Select/deselect all *currently visible* items
            const visibleItems = elements.transactionList.querySelectorAll('li[data-id]:not(.transaction-list-item--removing)');
            visibleItems.forEach(li => {
                updateListItemSelection(li, isChecked);
            });
            updateBulkActionUI(); // Update button state
        }

        /** Handles the theme toggle switch change. */
        function handleThemeToggle() {
            const newTheme = elements.themeCheckbox.checked ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme); // Save preference
            applyTheme(newTheme); // Apply the theme
        }

        // --- SECTION: Modal Logic ---

        /** Closes all currently open modals. */
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            // Clear IDs from modals to prevent accidental reuse
            elements.editId.value = '';
            elements.deleteId.value = '';
        }

        /** Opens the Edit modal and populates it with transaction data. */
        function openEditModal(id) {
            const transaction = transactions.find(tx => String(tx.ID) === id);
            if (!transaction) return; // Transaction not found

            // Populate common fields
            elements.editId.value = id;
            elements.editType.value = transaction.Type; // Store type (though not editable)
            elements.editAmount.value = transaction.Amount;
            elements.editDate.value = transaction.Date;
            elements.editNote.value = transaction.Note || '';

            // Dynamically create and populate the category select dropdown
            elements.editCategoryContainer.innerHTML = ''; // Clear previous content
            const label = document.createElement('label');
            label.htmlFor = 'edit-category-select';
            label.textContent = 'Category:';
            const select = document.createElement('select');
            select.id = 'edit-category-select';
            select.className = 'filter-select'; // Apply some styling if needed

            // Choose category list based on transaction type
            const categories = (transaction.Type === 'income') ? AppConfig.incomeCategories : AppConfig.expenseCategories;
            categories.forEach(cat => {
                const option = new Option(cat, cat);
                if (cat === transaction.Category) {
                    option.selected = true; // Pre-select current category
                }
                select.appendChild(option);
            });

            elements.editCategoryContainer.appendChild(label);
            elements.editCategoryContainer.appendChild(select);

            // Display the modal
            elements.editModal.style.display = 'flex';
        }

        /** Opens the Delete confirmation modal. */
        function openDeleteModal(id) {
            elements.deleteId.value = id; // Store ID to delete
            elements.deleteModal.style.display = 'flex';
        }

        /** Opens the Bulk Delete confirmation modal. */
        function openBulkDeleteModal() {
            const count = selectedTransactionIds.size;
            if (count === 0) {
                showNotification('No transactions selected for deletion.', 'warning');
                return;
            }
            elements.bulkDeleteCount.textContent = count; // Show how many will be deleted
            elements.bulkDeleteModal.style.display = 'flex';
        }

        /** Opens the Export modal and resets options. */
        function openExportModal() {
            // Reset export options to default
            elements.exportFormatSelect.value = 'csv';
            elements.exportRangeSelect.value = 'all';
            populateYearSelectors(); // Ensure year selectors are up-to-date
            toggleExportDateRangePicker(); // Hide/show date pickers based on default range
            elements.exportModal.style.display = 'flex';
        }

        /** Shows/hides date pickers in the export modal based on selected range. */
        function toggleExportDateRangePicker() {
            const selectedRange = elements.exportRangeSelect.value;
            // Show/hide containers based on selection
            elements.exportDateRangeContainer.style.display = (selectedRange === 'custom') ? 'flex' : 'none';
            elements.exportMonthYearContainer.style.display = (selectedRange === 'month') ? 'flex' : 'none';
            elements.exportYearContainer.style.display = (selectedRange === 'year') ? 'block' : 'none';

            // Set default values for date pickers when shown
            if (selectedRange === 'month') {
                elements.exportMonthSelect.value = dayjs().month() + 1; // Current month
                elements.exportMonthYearSelect.value = dayjs().year(); // Current year
            } else if (selectedRange === 'year') {
                elements.exportYearSelect.value = dayjs().year(); // Current year
            } else if (selectedRange === 'custom') {
                // Default custom range to last month
                elements.exportDateFrom.value = dayjs().subtract(1, 'month').format('YYYY-MM-DD');
                elements.exportDateTo.value = dayjs().format('YYYY-MM-DD');
            }
        }

        // --- SECTION: Export Logic ---

        /** Exports transaction data based on selected options. */
        function exportData() {
            const format = elements.exportFormatSelect.value;
            const range = elements.exportRangeSelect.value;
            let dataToExport = [];

            // Filter transactions based on selected range
            switch (range) {
                case 'all':
                    dataToExport = [...transactions];
                    break;
                case 'current': // Export only currently filtered/displayed transactions
                    dataToExport = [...currentlyDisplayedTransactions];
                    break;
                case 'month':
                    const exportMonth = parseInt(elements.exportMonthSelect.value);
                    const exportMonthYear = parseInt(elements.exportMonthYearSelect.value);
                    dataToExport = transactions.filter(t =>
                        dayjs(t.Date).year() === exportMonthYear &&
                        dayjs(t.Date).month() === exportMonth - 1 // 0-indexed month
                    );
                    break;
                case 'year':
                    const exportYear = parseInt(elements.exportYearSelect.value);
                    dataToExport = transactions.filter(t => dayjs(t.Date).year() === exportYear);
                    break;
                case 'custom':
                    const fromDate = elements.exportDateFrom.value;
                    const toDate = elements.exportDateTo.value;
                    if (!fromDate || !isValidDate(fromDate) || !toDate || !isValidDate(toDate)) {
                        showNotification('Invalid custom date range.', 'error'); return;
                    }
                    const startDate = dayjs(fromDate).startOf('day');
                    const endDate = dayjs(toDate).endOf('day');
                    if (startDate.isAfter(endDate)) {
                        showNotification('From date cannot be after To date.', 'error'); return;
                    }
                    dataToExport = transactions.filter(t => dayjs(t.Date).isBetween(startDate, endDate, 'day', '[]'));
                    break;
                default:
                    dataToExport = [...transactions]; // Default to all if range is unknown
            }

            if (dataToExport.length === 0) {
                showNotification("No data available for the selected export range.", 'warning');
                return;
            }

            // Sort data chronologically for export
            dataToExport.sort((a, b) => a.Timestamp - b.Timestamp);

            let fileContent = '', mimeType = 'text/plain', fileExtension = '.txt';
            const timestamp = dayjs().format('YYYYMMDD_HHmmss');
            let filename = `money_tracker_${range}_${timestamp}`;

            // Generate content based on format
            if (format === 'txt') {
                fileContent = generateTextExport(dataToExport);
                mimeType = 'text/plain';
                fileExtension = '.txt';
            } else if (format === 'csv') {
                fileContent = generateCSVExport(dataToExport);
                mimeType = 'text/csv';
                fileExtension = '.csv';
            } else if (format === 'json') {
                fileContent = JSON.stringify(dataToExport, null, 2); // Pretty print JSON
                mimeType = 'application/json';
                fileExtension = '.json';
            }

            filename += fileExtension;

            // Trigger the download
            triggerDownload(fileContent, mimeType, filename);
            closeModal(); // Close export modal
            showNotification(`Exported ${dataToExport.length} transactions as ${format.toUpperCase()}.`, 'success');
        }

        /** Generates a plain text representation of the data. */
        function generateTextExport(data) {
            let text = `Shared Money Tracker Export (${dayjs().format('YYYY-MM-DD HH:mm')})\n`;
            text += `Range: ${elements.exportRangeSelect.options[elements.exportRangeSelect.selectedIndex].text}\n`;
            text += '==================================================\n';
            text += 'Date\t\tTime\tType\tAmount\tCategory\tUser\tNote\n';
            text += '==================================================\n';
            data.forEach(t => {
                text += `${t.Date}\t`;
                text += `${dayjs(t.Timestamp).format('h:mm A')}\t`;
                text += `${t.Type.toUpperCase()}\t`;
                text += `${formatCurrency(t.Amount)}\t`;
                text += `${t.Category || ''}\t`;
                text += `${t.User || ''}\t`;
                text += `${t.Note || ''}\n`;
            });
            text += '==================================================\n';
            // Add summary
            const income = data.filter(t => t.Type === 'income').reduce((s, t) => s + t.Amount, 0);
            const expense = data.filter(t => t.Type === 'expense').reduce((s, t) => s + t.Amount, 0);
            text += 'Summary:\n';
            text += `Total Income: ${formatCurrency(income)}\n`;
            text += `Total Expenses: ${formatCurrency(expense)}\n`;
            text += `Balance: ${formatCurrency(income - expense)}\n`;
            return text;
        }

        /** Generates a CSV representation of the data. */
        function generateCSVExport(data) {
            // Define CSV headers matching the data structure
            const headers = ['ID', 'Timestamp', 'Date', 'Time', 'Type', 'Amount', 'Category', 'User', 'Note'];
            let csvContent = headers.join(',') + '\n'; // Header row

            // Add data rows
            data.forEach(t => {
                // Escape commas and quotes within fields
                const categoryEscaped = `"${(t.Category || '').replace(/"/g, '""')}"`;
                const noteEscaped = `"${(t.Note || '').replace(/"/g, '""')}"`;
                const userEscaped = `"${(t.User || '').replace(/"/g, '""')}"`;

                const row = [
                    t.ID,
                    t.Timestamp,
                    t.Date,
                    dayjs(t.Timestamp).format('HH:mm:ss'), // 24-hour time for CSV
                    t.Type,
                    t.Amount.toFixed(2), // Format amount to 2 decimal places
                    categoryEscaped,
                    userEscaped,
                    noteEscaped
                ];
                csvContent += row.join(',') + '\n';
            });

            // Add summary rows at the end (optional)
            const income = data.filter(t => t.Type === 'income').reduce((s, t) => s + t.Amount, 0);
            const expense = data.filter(t => t.Type === 'expense').reduce((s, t) => s + t.Amount, 0);
            csvContent += '\nSummary,,,,,,,,\n'; // Add empty fields to align
            csvContent += `Total Income,${income.toFixed(2)},,,,,,,,\n`;
            csvContent += `Total Expenses,${expense.toFixed(2)},,,,,,,,\n`;
            csvContent += `Balance,${(income - expense).toFixed(2)},,,,,,,,\n`;

            return csvContent;
        }

        /** Triggers a file download in the browser. */
        function triggerDownload(content, mimeType, filename) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = filename;
            document.body.appendChild(anchor); // Append to body to ensure click works
            anchor.click();
            document.body.removeChild(anchor); // Clean up
            URL.revokeObjectURL(url); // Release object URL
        }

        // --- SECTION: Utility Functions ---

        /** Checks if a string is a valid YYYY-MM-DD date. */
        function isValidDate(dateString) {
            return dayjs(dateString, 'YYYY-MM-DD', true).isValid();
        }

        /** Formats a number as currency (e.g., $123.45). */
        function formatCurrency(number) {
            // Ensure input is a number, default to 0 if not
            const num = Number(number);
            if (isNaN(num)) {
                return '$0.00';
            }
            return `$${num.toFixed(2)}`;
        }

        /** Escapes HTML special characters in a string. */
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        /** Populates year select dropdowns for filters and export. */
        function populateYearSelectors() {
            const currentYear = dayjs().year();
            const startYear = currentYear - AppConfig.yearSelectorRange;
            const endYear = currentYear + AppConfig.yearSelectorRange;

            const yearSelects = [
                elements.weekYearSelect, elements.monthYearSelect, elements.yearSelect,
                elements.exportMonthYearSelect, elements.exportYearSelect
            ];

            yearSelects.forEach(select => {
                if (!select) return;
                const currentValue = select.value; // Preserve current selection if valid
                select.innerHTML = ''; // Clear existing options
                for (let year = endYear; year >= startYear; year--) {
                    select.appendChild(new Option(year, year));
                }
                // Restore previous value or default to current year
                select.value = (currentValue && select.querySelector(`option[value="${currentValue}"]`)) ? currentValue : currentYear;
            });
        }

        /** Sets default dates in forms and filter dropdowns to current date/week/month/year. */
        function setDefaultDatesAndFilters() {
            const today = dayjs();
            const todayFormatted = today.format('YYYY-MM-DD');

            // Set date inputs in forms to today
            elements.expenseDate.value = todayFormatted;
            elements.incomeDate.value = todayFormatted;

            // Set default values for time period filter dropdowns
            const currentMonth = today.month() + 1; // 1-based month
            const currentYear = today.year();
            const currentWeek = getWeekOfMonth(today); // Calculate current week number

            elements.weekSelect.value = currentWeek;
            elements.weekMonthSelect.value = currentMonth;
            elements.weekYearSelect.value = currentYear;

            elements.monthSelect.value = currentMonth;
            elements.monthYearSelect.value = currentYear;

            elements.yearSelect.value = currentYear;
        }

        /** Calculates the week number of a given date within its month. */
        function getWeekOfMonth(date) {
            // Simple calculation: week = ceiling(day / 7), max 5
            const dayOfMonth = date.date();
            return Math.min(Math.ceil(dayOfMonth / 7), 5); // Cap at 5 for "Week 5+"
        }

        /** Removes the 'active' class from all time filter buttons. */
        function clearActiveTimeFilterButton() {
            document.querySelectorAll('.time-filter-btn').forEach(btn => btn.classList.remove('active'));
        }

        /** Hides all sub-filter rows (for week/month/year selection). */
        function hideSubFilterRows() {
            document.querySelectorAll('.sub-filter-row').forEach(row => row.style.display = 'none');
        }

        /** Updates the visibility and state of bulk action UI elements (Delete button, Select All checkbox). */
        function updateBulkActionUI() {
            const selectedCount = selectedTransactionIds.size;
            const visibleItems = elements.transactionList.querySelectorAll('li[data-id]:not(.transaction-list-item--removing)');
            const visibleCount = visibleItems.length;

            // Show bulk delete button only if items are selected
            elements.bulkDeleteBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';

            // Update Select All checkbox state
            if (visibleCount === 0) {
                // No visible items, disable and uncheck
                elements.selectAllCheckbox.checked = false;
                elements.selectAllCheckbox.indeterminate = false;
                elements.selectAllCheckbox.disabled = true;
            } else {
                // Visible items exist, enable checkbox
                elements.selectAllCheckbox.disabled = false;
                if (selectedCount === 0) {
                    // None selected
                    elements.selectAllCheckbox.checked = false;
                    elements.selectAllCheckbox.indeterminate = false;
                } else if (selectedCount === visibleCount) {
                    // All visible selected
                    elements.selectAllCheckbox.checked = true;
                    elements.selectAllCheckbox.indeterminate = false;
                } else {
                    // Some (but not all) visible selected
                    elements.selectAllCheckbox.checked = false;
                    elements.selectAllCheckbox.indeterminate = true; // Indeterminate state
                }
            }
        }

        /**
         * Sets the default user in the Add Expense/Income forms based on the logged-in user's role.
         * @param {string|null} role - The role determined by the backend ('Husband', 'Wife', or null).
         */
        function setDefaultUserForms(role) {
             if (role && AppConfig.users.includes(role)) {
                 if (elements.expenseUser) {
                     elements.expenseUser.value = role;
                     // Optionally disable: elements.expenseUser.disabled = true;
                 }
                 if (elements.incomeUser) {
                     elements.incomeUser.value = role;
                     // Optionally disable: elements.incomeUser.disabled = true;
                 }
                 console.log(`Default user set to: ${role}`);
             } else {
                 console.warn("Could not set default user form - role not provided or invalid:", role);
                 // Optionally handle this case, e.g., show a message or leave dropdowns as is.
                 // If role is null/invalid, maybe default to the first user in the list or show an error?
                 // For now, it leaves the dropdowns potentially unset if the role isn't matched.
                 if (elements.expenseUser && AppConfig.users.length > 0) elements.expenseUser.value = AppConfig.users[0];
                 if (elements.incomeUser && AppConfig.users.length > 0) elements.incomeUser.value = AppConfig.users[0];

             }
         }


        // --- SECTION: App Start ---
        // Initialize the application when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
